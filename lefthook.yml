# git-work-log Lefthooké…ç½®
# è¯¦ç»†æ–‡æ¡£: https://lefthook.dev/configuration/

# æäº¤å‰é’©å­
pre-commit:
  parallel: true
  commands:
    # æ ¼å¼åŒ–Goä»£ç 
    go-fmt:
      glob: "*.go"
      run: |
        # å¯¹æ‰€æœ‰æš‚å­˜çš„Goæ–‡ä»¶è¿è¡Œgo fmt
        for file in {staged_files}; do
          go fmt $file
        done
    
    # è¿è¡ŒGoé™æ€ä»£ç åˆ†æ
    go-vet:
      glob: "*.go"
      run: |
        # å¯¹æ•´ä¸ªé¡¹ç›®è¿è¡Œgo vet
        go vet ./...
        # å¦‚æœæœ‰é”™è¯¯ï¼Œè¿”å›éé›¶çŠ¶æ€ç 
        if [ $? -ne 0 ]; then
          exit 1
        fi
      
    # è¿è¡Œgolangci-lintä»£ç æ£€æŸ¥Â·
    golangci-lint:
      glob: "*.go"
      run: |
        # å¯¹æ•´ä¸ªé¡¹ç›®è¿è¡Œgolangci-lintï¼Œè€Œä¸æ˜¯é’ˆå¯¹å•ä¸ªæ–‡ä»¶
        golangci-lint run --config=.golangci.yml ./...
        # å¦‚æœæœ‰é”™è¯¯ï¼Œè¿”å›éé›¶çŠ¶æ€ç 
        if [ $? -ne 0 ]; then
          exit 1
        fi

# æ¨é€å‰é’©å­
pre-push:
  commands:
    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
    go-test:
      run: go test -v ./...
      
    # ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    test-coverage:
      run: |
        go test -coverprofile=coverage.out ./...
        go tool cover -func=coverage.out
        echo "è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Šå¯é€šè¿‡è¿è¡Œ 'go tool cover -html=coverage.out' æŸ¥çœ‹"

# æäº¤æ¶ˆæ¯é’©å­
commit-msg:
  commands:
    # æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼
    validate-commit-message:
      run: |
        # è·å–æäº¤æ¶ˆæ¯æ–‡ä»¶
        COMMIT_MSG_FILE="{1}"
        if [ ! -f "$COMMIT_MSG_FILE" ]; then
          echo "é”™è¯¯: æ— æ³•æ‰¾åˆ°æäº¤æ¶ˆæ¯æ–‡ä»¶"
          exit 1
        fi
        
        # è¯»å–æäº¤æ¶ˆæ¯
        COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
        TYPES="feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert|wip"
        
        # æ£€æŸ¥æäº¤æ¶ˆæ¯æ˜¯å¦ç¬¦åˆæ ¼å¼è¦æ±‚ (æ”¯æŒè¡¨æƒ…ç¬¦å·)
        if ! echo "$COMMIT_MSG" | grep -qE "^($TYPES)(\(.+\))?(!)?(: |:\s*).+"; then
          echo "é”™è¯¯: æäº¤æ¶ˆæ¯ä¸ç¬¦åˆçº¦å®šå¼æäº¤è§„èŒƒ"
          echo "æ ¼å¼åº”ä¸º: <ç±»å‹>(å¯é€‰ä½œç”¨åŸŸ)(å¯é€‰!): <æè¿°>"
          echo "ç±»å‹å¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€: $TYPES"
          echo "æè¿°å¯ä»¥åŒ…å«è¡¨æƒ…ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦"
          echo "ç¤ºä¾‹:"
          echo "  feat(report): æ·»åŠ å‘¨æŠ¥ç”ŸæˆåŠŸèƒ½"
          echo "  feat: ğŸ¸ åˆå§‹åŒ–é¡¹ç›®"
          echo "  fix(parser)!: ä¿®å¤å…³é”®é”™è¯¯"
          exit 1
        fi
